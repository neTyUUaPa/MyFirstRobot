#!/usr/bin/env python3
import cv2
import numpy as np
import serial
import time

# Настройка UART
try:
    serial_port = serial.Serial(
        port='/dev/serial0',
        baudrate=9600,
        timeout=1
    )
    print("UART успешно открыт")
except Exception as e:
    print(f"Ошибка при открытии UART: {e}")
    exit()

# Параметры камеры
FRAME_WIDTH = 640
FRAME_HEIGHT = 480
FOCAL_LENGTH_MM = 1.8
SENSOR_WIDTH_MM = 4.8

FOCAL_LENGTH_PX = (FOCAL_LENGTH_MM * FRAME_WIDTH) / SENSOR_WIDTH_MM

cap = cv2.VideoCapture(0)
cap.set(3, FRAME_WIDTH)
cap.set(4, FRAME_HEIGHT)

lower_red1 = np.array([0, 100, 50])
upper_red1 = np.array([15, 255, 255])
lower_red2 = np.array([165, 100, 50])
upper_red2 = np.array([180, 255, 255])

while True:
    ret, frame = cap.read()
    if not ret:
        print("Не удалось захватить кадр")
        time.sleep(1)
        continue

    hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV)
    mask1 = cv2.inRange(hsv, lower_red1, upper_red1)
    mask2 = cv2.inRange(hsv, lower_red2, upper_red2)
    mask = mask1 + mask2

    contours, _ = cv2.findContours(mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    realAngle = 0
    if contours:
        for contour in contours:
            if cv2.contourArea(contour) > 500:
                x, y, w, h = cv2.boundingRect(contour)
                cx = x + w // 2
                cy = y + h // 2
                x_center = FRAME_WIDTH // 2
                angle = np.degrees(np.arctan((cx - x_center) / FOCAL_LENGTH_PX))
                realAngle = (0.0001 * (angle ** 3)) - (0.00009 * (angle ** 2)) + (0.5109 * angle) - 2.0225
                cv2.rectangle(frame, (x, y), (x + w, y + h), (0, 255, 0), 2)
                cv2.circle(frame, (cx, cy), 5, (0, 0, 255), -1)
                cv2.putText(frame, f"Angle: {realAngle:.2f} deg", (x, y - 10), cv2.FONT_HERSHEY_SIMPLEX, 0.5, (255, 255, 255), 2)
                print(f"Объект найден, угол: {realAngle:.2f}")

    if serial_port.in_waiting > 0:
        request = serial_port.read(serial_port.in_waiting).decode('utf-8').strip()
        print(f"Получен запрос: {request}")
        if request == "GET_ANGLE":
            serial_port.write(f"{realAngle:.2f}\n".encode('utf-8'))
            print(f"Отправлен угол: {realAngle:.2f}")

    cv2.imshow('Frame', frame)
    cv2.imshow('Mask', mask)
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
serial_port.close()